name: Simple Playlist Download
on: workflow_dispatch

permissions:
  contents: write

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出仓库（使用完整权限）
      - name: Checkout with full permissions
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true  # 重要：保持认证信息
          
      # 2. 下载文件
      - name: Download the playlist
        run: |
          curl -s -o tv.txt "http://43.251.226.89:8080/live.txt"
          echo "下载完成，文件大小: $(wc -c < tv.txt) 字节"
          
      # 3. 配置Git
      - name: Setup Git
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
      # 4. 强制提交和推送
      - name: Force commit and push
        run: |
          # 确保在正确的分支
          git checkout ${{ github.ref_name }}
          
          # 强制添加和提交
          git add -f tv.txt
          git commit -m "Update playlist $(date)" || echo "可能没有变化"
          
          # 强制推送
          git push --force-with-lease origin ${{ github.ref_name }}
          echo "✅ 文件已推送到仓库"
