name: Update TV Playlist

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 1 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°'

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # ç¡®ä¿æœ‰å†™å…¥ä»“åº“çš„æƒé™
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
          persist-credentials: true  # ä¿æŒè®¤è¯ä¿¡æ¯

      - name: ä¸‹è½½æ’­æ”¾åˆ—è¡¨
        run: |
          # åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p data
          
          # ä¸‹è½½txtæ–‡ä»¶å†…å®¹
          echo "æ­£åœ¨ä¸‹è½½æ’­æ”¾åˆ—è¡¨..."
          curl -s -L "${{ secrets.PLAYLIST_URL || 'http://43.251.226.89:8080/live.txt' }}" -o data/tv.txt
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
          if [ -s "data/tv.txt" ]; then
            echo "âœ“ æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
            echo "æ–‡ä»¶å¤§å°: $(wc -l < data/tv.txt) è¡Œ"
          else
            echo "âœ— æ–‡ä»¶ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi
          
          # è®¾ç½®æ–‡ä»¶è¯»å†™æƒé™ï¼ˆé»˜è®¤é€šå¸¸å·²æœ‰ï¼‰
          chmod 644 data/tv.txt
          
          # æ˜¾ç¤ºæ–‡ä»¶å‰5è¡Œå†…å®¹ä½œä¸ºéªŒè¯
          echo "æ–‡ä»¶å‰5è¡Œå†…å®¹:"
          head -5 data/tv.txt
          
          # ç»Ÿè®¡ä¸åŒç±»å‹çš„é“¾æ¥æ•°é‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
          echo "æ–‡ä»¶ç»Ÿè®¡:"
          echo "æ€»è¡Œæ•°: $(wc -l < data/tv.txt)"
          echo "åŒ…å«httpçš„è¡Œæ•°: $(grep -c "http" data/tv.txt || true)"

      - name: æäº¤æ›´æ–°
        run: |
          # é…ç½®Gitç”¨æˆ·
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet data/tv.txt; then
            echo "æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œæ­£åœ¨æäº¤..."
            git add data/tv.txt
            git commit -m "ğŸ”„ æ›´æ–°æ’­æ”¾åˆ—è¡¨ $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ“ å·²æäº¤æ›´æ–°"
          fi

      - name: éªŒè¯æ–‡ä»¶æƒé™
        run: |
          echo "æ–‡ä»¶æƒé™ä¿¡æ¯:"
          ls -la data/tv.txt
          echo -e "\næ–‡ä»¶æ‰€æœ‰æƒ:"
          stat -c "ç”¨æˆ·:%U ç»„:%G æƒé™:%A" data/tv.txt
