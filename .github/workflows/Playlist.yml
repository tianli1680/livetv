name: Download and Save Playlist

on:
  # 手动触发
  workflow_dispatch:
  # 自动定时触发（可选，示例为每天凌晨2点运行）
  schedule:
    - cron: '0 2 * * *'

jobs:
  download-file:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download playlist file
        run: |
          # 下载文件并保存为 tv.txt
          curl -s -o tv.txt "http://43.251.226.89:8080/live.txt"
          
          # 检查文件是否下载成功
          if [ -f "tv.txt" ]; then
            echo "文件下载成功"
            # 显示文件基本信息
            echo "文件大小: $(wc -l < tv.txt) 行"
            echo "前5行内容预览:"
            head -5 tv.txt
          else
            echo "文件下载失败"
            exit 1
          fi
        
      - name: Set file permissions
        run: |
          # 设置读写权限（644：所有者读写，其他用户只读）
          chmod 644 tv.txt
          
          # 验证权限
          echo "文件权限:"
          ls -la tv.txt
        
      - name: Commit and push changes
        run: |
          # 配置git用户
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 检查文件是否有变化
          if git diff --quiet; then
            echo "文件没有变化，无需提交"
          else
            # 提交更改
            git add tv.txt
            git commit -m "更新播放列表文件 tv.txt [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push
          fi
